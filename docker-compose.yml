services:
  redis:
    image: redis:7-alpine
    container_name: stock_redis
    cpus: "0.7"
    # ğŸ”’ å®‰å…¨é…ç½®ï¼šRedis ä»…å…è®¸ Docker å†…éƒ¨è®¿é—®ï¼Œä¸æš´éœ²åˆ°å…¬ç½‘
    # ç§»é™¤äº† ports æ˜ å°„ï¼ŒRedis åªèƒ½é€šè¿‡ Docker å†…éƒ¨ç½‘ç»œè®¿é—®
    # Docker ç½‘ç»œå†…çš„å…¶ä»–æœåŠ¡ï¼ˆstock_apiã€stock_collectorï¼‰å¯ä»¥é€šè¿‡æœåŠ¡å "redis" è®¿é—®
    # å¦‚æœéœ€è¦ä»å®¿ä¸»æœºè®¿é—® Redisï¼ˆä»…ç”¨äºè°ƒè¯•ï¼‰ï¼Œå¯ä»¥ä¸´æ—¶æ·»åŠ ï¼š
    # ports:
    #   - "127.0.0.1:6379:6379"  # åªç»‘å®šåˆ°æœ¬åœ°å›ç¯åœ°å€ï¼Œä¸æš´éœ²åˆ°å…¬ç½‘
    expose:
      - "6379"  # ä»…æš´éœ²ç»™ Docker ç½‘ç»œå†…çš„å…¶ä»–å®¹å™¨
    volumes:
      - redis_data:/data
    restart: always
    env_file:
      - .env
    environment:
      # å°† REDIS_PASSWORD ä¼ é€’ç»™ Redis å®¹å™¨ï¼Œç”¨äºé…ç½® requirepass
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - TZ=Asia/Shanghai
    # å¯ç”¨ AOF å’Œ RDB åŒé‡æŒä¹…åŒ–ï¼Œç¡®ä¿æ•°æ®ä¸ä¸¢å¤±
    # --appendonly yes: å¯ç”¨ AOFï¼ˆAppend Only Fileï¼‰æŒä¹…åŒ–
    # --appendfsync everysec: æ¯ç§’åŒæ­¥ä¸€æ¬¡ AOF æ–‡ä»¶
    # --auto-aof-rewrite-percentage 100: å½“ AOF æ–‡ä»¶å¤§å°æ¯”ä¸Šæ¬¡é‡å†™åçš„å¤§å°å¢é•¿ 100% æ—¶è§¦å‘é‡å†™
    # --auto-aof-rewrite-min-size 64mb: AOF æ–‡ä»¶æœ€å°é‡å†™å¤§å°ä¸º 64MB
    # --save 60 1000: å¦‚æœ60ç§’å†…è‡³å°‘æœ‰1000ä¸ªkeyå‘ç”Ÿå˜åŒ–ï¼Œåˆ™ä¿å­˜RDBå¿«ç…§
    # --save 300 100: å¦‚æœ300ç§’å†…è‡³å°‘æœ‰100ä¸ªkeyå‘ç”Ÿå˜åŒ–ï¼Œåˆ™ä¿å­˜RDBå¿«ç…§
    # --save 900 1: å¦‚æœ900ç§’å†…è‡³å°‘æœ‰1ä¸ªkeyå‘ç”Ÿå˜åŒ–ï¼Œåˆ™ä¿å­˜RDBå¿«ç…§
    # --requirepass: å¦‚æœè®¾ç½®äº† REDIS_PASSWORD ç¯å¢ƒå˜é‡ï¼Œåˆ™å¯ç”¨å¯†ç è®¤è¯
    # --bind 0.0.0.0: å…è®¸ Docker ç½‘ç»œå†…çš„æ‰€æœ‰å®¹å™¨è®¿é—®ï¼ˆé»˜è®¤è¡Œä¸ºï¼‰
    command: >
      sh -c "
      if [ -n \"$$REDIS_PASSWORD\" ]; then
        redis-server --appendonly yes --appendfsync everysec --auto-aof-rewrite-percentage 100 --auto-aof-rewrite-min-size 64mb --save "" --requirepass \"$$REDIS_PASSWORD\" --bind 0.0.0.0
      else
        redis-server --appendonly yes --appendfsync everysec --auto-aof-rewrite-percentage 100 --auto-aof-rewrite-min-size 64mb --save "" --bind 0.0.0.0
      fi
      "

  clickhouse:
    image: clickhouse/clickhouse-server:latest
    container_name: stock_clickhouse
    cpus: "0.7"
    ports:
      - "8123:8123"
      - "9000:9000"
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      # - ./clickhouse-config:/etc/clickhouse-server/config.d
    environment:
      CLICKHOUSE_DB: ${CLICKHOUSE_DB:-stock}
      CLICKHOUSE_USER: ${CLICKHOUSE_USER:-default}
      # é»˜è®¤å¯†ç ä¸ºå¼±å£ä»¤ï¼Œä»…ç”¨äºæœ¬åœ°å¼€å‘ç¯å¢ƒï¼Œç”Ÿäº§ç¯å¢ƒåŠ¡å¿…é€šè¿‡ç¯å¢ƒå˜é‡è¦†ç›–
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-changeme}
      TZ: Asia/Shanghai
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    restart: unless-stopped

  collector:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: stock_collector
    cpus: "0.7"
    command: python -m market_collector.scheduler
    depends_on:
      - redis
    volumes:
      # æŒ‚è½½ä»£ç ç›®å½•ï¼Œä¿®æ”¹ä»£ç åæ— éœ€é‡å»ºé•œåƒ
      - ./backend:/app
    restart: always
    env_file:
      - .env
    environment:
      - TZ=Asia/Shanghai
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DB=${REDIS_DB:-0}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}

  api:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: stock_api
    cpus: "0.7"
    command: uvicorn gateway.app:app --host 0.0.0.0 --port 8000 --reload
    ports:
      - "8000:8000"
    depends_on:
      - redis
      - clickhouse
    volumes:
      # æŒ‚è½½ä»£ç ç›®å½•ï¼Œä¿®æ”¹ä»£ç åæ— éœ€é‡å»ºé•œåƒï¼Œ--reload å‚æ•°ä¼šè‡ªåŠ¨é‡è½½ä»£ç 
      - ./backend:/app
      # æŒ‚è½½å‰ç«¯ç›®å½•ï¼Œä½¿å‰ç«¯æ–‡ä»¶å¯è®¿é—®ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
      - ./frontend:/app/frontend
    restart: always
    env_file:
      - .env
    environment:
      - TZ=Asia/Shanghai
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DB=${REDIS_DB:-0}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - CLICKHOUSE_HOST=${CLICKHOUSE_HOST:-clickhouse}
      - CLICKHOUSE_PORT=${CLICKHOUSE_PORT:-9000}
      - CLICKHOUSE_DB=${CLICKHOUSE_DB:-stock}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER:-default}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD:-changeme}
      - API_HOST=${API_HOST:-0.0.0.0}
      - API_PORT=${API_PORT:-8000}
      - API_ALLOWED_ORIGINS=${API_ALLOWED_ORIGINS:-*}
      - API_AUTH_TOKEN=${API_AUTH_TOKEN:-}
      - ADMIN_TOKEN=${ADMIN_TOKEN:-}
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    networks:
      - default
      - npm-net

volumes:
  # Redis æ•°æ®æŒä¹…åŒ–å·ï¼ˆå‘½åå·ï¼Œæ•°æ®ä¼šæŒä¹…åŒ–åˆ° Docker ç®¡ç†çš„å­˜å‚¨ä½ç½®ï¼‰
  redis_data:
    driver: local
    # ç”Ÿäº§ç¯å¢ƒå»ºè®®ï¼šå¯ä»¥æŒ‡å®šå…·ä½“è·¯å¾„ï¼Œä¾‹å¦‚ï¼š
    # driver_opts:
    #   type: none
    #   o: bind
    #   device: /opt/agjiankong/data/redis
  # ClickHouse æ•°æ®æŒä¹…åŒ–å·ï¼ˆå‘½åå·ï¼Œæ•°æ®ä¼šæŒä¹…åŒ–åˆ° Docker ç®¡ç†çš„å­˜å‚¨ä½ç½®ï¼‰
  clickhouse_data:
    driver: local
    # ç”Ÿäº§ç¯å¢ƒå»ºè®®ï¼šå¯ä»¥æŒ‡å®šå…·ä½“è·¯å¾„ï¼Œä¾‹å¦‚ï¼š
    # driver_opts:
    #   type: none
    #   o: bind
    #   device: /opt/agjiankong/data/clickhouse

networks:
  # è¿æ¥åˆ° Nginx Proxy Manager ç½‘ç»œï¼Œç”¨äºåå‘ä»£ç†
  npm-net:
    external: true

