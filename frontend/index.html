<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=1080, initial-scale=0.33, maximum-scale=5.0, user-scalable=yes">
    <title>行情监控</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📈</text></svg>">
    <script>
        // 动态调整视口
        (function() {
            var vp = document.querySelector('meta[name="viewport"]');
            if (!vp) return;
            
            // 检测是否通过反代访问（域名访问）
            var isProxy = window.location.hostname.indexOf('.') > -1 && 
                          !window.location.hostname.match(/^\d+\.\d+\.\d+\.\d+$/);
            
            if (isProxy) {
                // 反代访问，使用标准视口
                vp.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes');
            }
            // 直接IP访问保持固定宽度1080
        })();
    </script>
    <link rel="stylesheet" href="/style.css?v=20251225_11">
    <script>
        // 在页面渲染前就设置正确的tab，避免闪烁
        // 使用立即执行的函数，尽可能早地执行
        (function() {
            try {
                const savedTab = localStorage.getItem('currentTab') || 'market';
                const validTabs = ['market', 'watchlist', 'strategy', 'ai', 'news', 'config'];
                const targetTab = validTabs.includes(savedTab) ? savedTab : 'market';
                
                // 保存目标tab到全局变量，供DOMContentLoaded时使用
                window.__initialTab = targetTab;
                
                // 立即尝试设置（如果DOM已存在）
                function setInitialTab() {
                    // 移除所有active类
                    const allTabs = document.querySelectorAll('.tab-btn');
                    const allContents = document.querySelectorAll('.tab-content');
                    
                    allTabs.forEach(btn => btn.classList.remove('active'));
                    allContents.forEach(content => content.classList.remove('active'));
                    
                    // 设置正确的active类
                    const targetBtn = document.querySelector(`.tab-btn[data-tab="${targetTab}"]`);
                    const targetContent = document.getElementById(`${targetTab}-tab`);
                    
                    if (targetBtn) targetBtn.classList.add('active');
                    if (targetContent) targetContent.classList.add('active');
                }
                
                // 如果DOM已经存在，立即执行
                if (document.body) {
                    setInitialTab();
                } else {
                    // 否则等待DOMContentLoaded
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', setInitialTab, false);
                    } else {
                        // 如果readyState不是loading，说明可能已经加载完成
                        setTimeout(setInitialTab, 0);
                    }
                }
            } catch (e) {
                console.warn('设置初始tab失败:', e);
            }
        })();
    </script>
    <style>
        /* 在CSS加载前先隐藏所有tab-content，避免闪烁 */
        .tab-content {
            display: none !important;
        }
        .tab-content.active {
            display: block !important;
        }
    </style>
    <script>
        // 在页面渲染前检查登录状态和主题，避免闪烁
        (function() {
            try {
                // 1. 检查并应用主题（在CSS加载前设置，避免主题闪烁）
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme === 'light') {
                    // 立即尝试应用主题（如果DOM已存在）
                    if (document.body) {
                        document.body.classList.add('light-mode');
                    } else {
                        // 如果body还不存在，等待DOMContentLoaded
                        document.addEventListener('DOMContentLoaded', function() {
                            document.body.classList.add('light-mode');
                        }, false);
                    }
                }
                
                // 注意：登录状态检查移到initAuth函数中处理，确保token验证的准确性
            } catch (e) {
                console.warn('初始化失败:', e);
            }
        })();
    </script>
</head>
<body>
    <!-- 登录遮罩层 -->
    <div id="login-overlay" style="position: fixed; inset: 0; background: rgba(15,23,42,0.9); display: flex; align-items: center; justify-content: center; z-index: 1000;">
        <div style="background: #0f172a; padding: 24px 28px; border-radius: 12px; width: 320px; box-shadow: 0 20px 40px rgba(15,23,42,0.8); border: 1px solid #1e293b;">
            <h2 style="margin: 0 0 16px; font-size: 20px; color: #e5e7eb; text-align: center;">管理员登录</h2>
            <form id="login-form">
                <div style="margin-bottom: 10px;">
                    <label style="display:block; font-size: 13px; color:#cbd5f5; margin-bottom:4px;">用户名</label>
                    <input id="login-username" type="text" value="admin" style="width: 100%; padding: 8px 10px; border-radius: 6px; border: 1px solid #1f2937; background:#020617; color:#e5e7eb;">
                </div>
                <div style="margin-bottom: 14px;">
                    <label style="display:block; font-size: 13px; color:#cbd5f5; margin-bottom:4px;">密码</label>
                    <input id="login-password" type="password" value="admin" style="width: 100%; padding: 8px 10px; border-radius: 6px; border: 1px solid #1f2937; background:#020617; color:#e5e7eb;">
                </div>
                <button type="submit" style="width:100%; padding:8px 0; border:none; border-radius:6px; background:#3b82f6; color:white; font-weight:600; cursor:pointer;">
                    登录
                </button>
                <div id="login-message" style="margin-top:8px; font-size:12px; color:#f97316; min-height:16px;"></div>
            </form>
        </div>
    </div>

    <div class="container">
        <!-- 头部导航 -->
        <header class="header">
            <h1>📈 行情监控</h1>
            <div class="nav-tabs">
                <button class="tab-btn" data-tab="market">行情</button>
                <button class="tab-btn" data-tab="watchlist">自选</button>
                <button class="tab-btn" data-tab="strategy">选股</button>
                <button class="tab-btn" data-tab="ai">AI分析</button>
                <button class="tab-btn" data-tab="news">资讯</button>
                <button class="tab-btn" data-tab="config">配置</button>
            </div>
            <div class="header-actions">
                <!-- 实时数据采集状态 -->
                <div id="spot-collect-result" class="spot-collect-result" style="display: none;">
                    <div class="spot-result-row">
                        <span class="spot-result-label">A股:</span>
                        <span id="spot-result-a-text" class="spot-result-value">✅ 5419只</span>
                        <span id="spot-result-a-time" class="spot-result-time">17:51</span>
                    </div>
                    <div class="spot-result-row">
                        <span class="spot-result-label">港股:</span>
                        <span id="spot-result-hk-text" class="spot-result-value">✅ 2000只</span>
                        <span id="spot-result-hk-time" class="spot-result-time">17:51</span>
                    </div>
                    <div class="spot-result-row">
                        <span class="spot-result-label">A源:</span>
                        <span id="spot-collect-result-a-source" class="spot-result-source">Easyquotation</span>
                    </div>
                    <div class="spot-result-row">
                        <span class="spot-result-label">H源:</span>
                        <span id="spot-collect-result-hk-source" class="spot-result-source">新浪财经</span>
                    </div>
                </div>
                <div class="market-status">
                    <div class="market-status-item">
                        <span class="market-status-label">A股:</span>
                        <span id="market-status-a" class="market-status-value">加载中...</span>
                    </div>
                    <div class="market-status-item">
                        <span class="market-status-label">港股:</span>
                        <span id="market-status-hk" class="market-status-value">加载中...</span>
                    </div>
                    <div class="market-status-item">
                        <span class="market-status-label">SSE:</span>
                        <span id="sse-status-indicator" class="sse-status-indicator disconnected" title="SSE连接状态"></span>
                        <span id="sse-status-text" class="market-status-value" style="margin-left: 4px;">未连接</span>
                    </div>
                </div>
                <button id="theme-toggle" class="theme-toggle-btn" type="button">🌙 夜间</button>
            </div>
        </header>

        <!-- 行情面板 -->
        <section id="market-tab" class="tab-content">
            <div class="market-controls">
                <select id="market-select">
                    <option value="a">A股</option>
                    <option value="hk">港股</option>
                </select>
                <input type="text" id="search-input" placeholder="搜索股票代码或名称...">
                <button id="refresh-btn">刷新</button>
            </div>
            <!-- 排序和过滤栏 -->
            <div class="market-sort-bar">
                <div class="sort-tabs">
                    <button class="sort-tab active" data-sort="default">默认</button>
                    <button class="sort-tab" data-sort="pct_desc">涨幅↓</button>
                    <button class="sort-tab" data-sort="pct_asc">涨幅↑</button>
                    <button class="sort-tab" data-sort="volume_desc">成交量↓</button>
                    <button class="sort-tab" data-sort="amount_desc">成交额↓</button>
                    <button class="sort-tab" data-sort="turnover_desc">换手率↓</button>
                </div>
                <label class="filter-checkbox">
                    <input type="checkbox" id="filter-stock-only">
                    <span>仅显示股票</span>
                </label>
            </div>
            <div class="stock-list-container">
                <table class="stock-table">
                    <thead>
                        <tr>
                            <th>代码</th>
                            <th>名称</th>
                            <th>最新价</th>
                            <th>涨跌幅</th>
                            <th>成交量</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="stock-list">
                        <tr><td colspan="6" class="loading">加载中...</td></tr>
                    </tbody>
                </table>
            </div>
            <div style="color: #94a3b8; font-size: 12px; margin-top: 10px; text-align: center;">💡 单击股票行可查看K线和详情</div>
        </section>

        <!-- 自选股面板 -->
        <section id="watchlist-tab" class="tab-content">
            <div class="watchlist-controls">
                <div style="color: #94a3b8; font-size: 14px;">自选股列表（单击股票查看K线和详情）</div>
            </div>
            <div id="watchlist-container" class="watchlist-container">
                <div class="watchlist-placeholder">
                    <div style="font-size: 48px; margin-bottom: 16px;">⭐</div>
                    <div style="font-size: 18px; color: #94a3b8; margin-bottom: 8px;">暂无自选股</div>
                    <div style="font-size: 14px; color: #64748b;">在行情页点击"加入自选"按钮添加股票</div>
                </div>
            </div>
        </section>
        
        <!-- K线模态弹窗 -->
        <div id="kline-modal" class="kline-modal" style="display: none;">
            <div class="kline-modal-overlay" onclick="closeKlineModal(event)"></div>
            <div class="kline-modal-content">
                <!-- 头部区域：标题、股票详情、操作按钮 -->
                <header class="kline-modal-header">
                    <div class="kline-header-main">
                        <h3 id="kline-modal-title" class="kline-title">K线图</h3>
                        <div id="stock-detail-info" class="stock-detail-info"></div>
                    </div>
                    <div class="kline-header-actions">
                        <button id="kline-refresh-btn" class="kline-action-btn kline-refresh-btn" title="刷新K线数据">
                            <span class="btn-icon">🔄</span>
                            <span class="btn-text">刷新</span>
                        </button>
                        <button class="kline-action-btn kline-modal-close" onclick="closeKlineModal(event)" title="关闭">
                            <span class="btn-icon">×</span>
                        </button>
                    </div>
                </header>
                
                <!-- 主体区域 -->
                <div class="kline-modal-body">
                    <!-- 控制栏：周期选择 + 指标控制 -->
                    <div class="kline-controls-bar">
                        <div class="kline-controls-group">
                            <label class="control-label">周期</label>
                            <select id="chart-period" class="kline-select">
                                <option value="1h">1小时</option>
                                <option value="daily">日线</option>
                                <option value="weekly">周线</option>
                                <option value="monthly">月线</option>
                            </select>
                        </div>
                        <div class="kline-controls-group kline-indicators-group">
                            <div class="indicator-toggle" data-target="volume-controls">
                                <span class="indicator-label">成交量</span>
                                <span class="indicator-arrow">▼</span>
                            </div>
                            <div id="volume-controls" class="indicator-panel">
                                <!-- 成交量控制内容在 JS 中填充 -->
                            </div>
                        </div>
                        <div class="kline-controls-group kline-indicators-group">
                            <div class="indicator-toggle" data-target="ema-controls">
                                <span class="indicator-label">EMA</span>
                                <span class="indicator-arrow">▼</span>
                            </div>
                            <div id="ema-controls" class="indicator-panel">
                                <!-- EMA 控制内容在 JS 中填充 -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- K线图容器 -->
                    <div id="chart-container" class="kline-chart-container"></div>
                    
                    <!-- 指标信息栏 -->
                    <div id="indicators-info" class="indicators-info-bar"></div>
                </div>
            </div>
        </div>

        <!-- 选股面板 -->
        <section id="strategy-tab" class="tab-content">
            <!-- 选股配置折叠区域 -->
            <div class="selection-config-section">
                <div class="selection-config-header" onclick="toggleSelectionConfig()">
                    <h3>🎯 选股配置</h3>
                    <span class="selection-config-arrow" id="selection-config-arrow">▶</span>
                </div>
                <div class="selection-config-content hidden" id="selection-config-content">
                    <!-- TradingView 风格的指标标签栏 -->
                    <div class="tv-filter-tabs">
                        <div class="tv-filter-tab" data-filter="stock-only">
                            <input type="checkbox" id="filter-stock-only-enable" checked>
                            <span class="tv-tab-name">仅股票</span>
                        </div>
                        <div class="tv-filter-tab has-dropdown" data-filter="market-cap">
                            <input type="checkbox" id="filter-market-cap-enable">
                            <span class="tv-tab-name">市值</span>
                            <span class="tv-tab-arrow">▼</span>
                            <div class="tv-dropdown">
                                <div class="tv-dropdown-header">
                                    <span>总市值筛选</span>
                                    <button type="button" onclick="resetFilter('market-cap', event)">重设</button>
                                </div>
                                <div class="tv-dropdown-body">
                                    <div class="tv-field">
                                        <label>最小值(亿)</label>
                                        <input type="number" id="filter-market-cap-min" value="1" min="0" step="1">
                                    </div>
                                    <div class="tv-field">
                                        <label>最大值(亿)</label>
                                        <input type="number" id="filter-market-cap-max" value="100000" min="0" step="100">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tv-filter-tab has-dropdown" data-filter="rsi">
                            <input type="checkbox" id="filter-rsi-enable" checked>
                            <span class="tv-tab-name">RSI</span>
                            <span class="tv-tab-arrow">▼</span>
                            <div class="tv-dropdown">
                                <div class="tv-dropdown-header">
                                    <span>相对强弱指标 (RSI)</span>
                                    <button type="button" onclick="resetFilter('rsi', event)">重设</button>
                                </div>
                                <div class="tv-dropdown-body">
                                    <div class="tv-field">
                                        <label>最小值</label>
                                        <input type="number" id="filter-rsi-min" value="30" min="0" max="100">
                                    </div>
                                    <div class="tv-field">
                                        <label>最大值</label>
                                        <input type="number" id="filter-rsi-max" value="75" min="0" max="100">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tv-filter-tab has-dropdown" data-filter="volume-ratio">
                            <input type="checkbox" id="filter-volume-ratio-enable" checked>
                            <span class="tv-tab-name">量比</span>
                            <span class="tv-tab-arrow">▼</span>
                            <div class="tv-dropdown">
                                <div class="tv-dropdown-header">
                                    <span>量比</span>
                                    <button type="button" onclick="resetFilter('volume-ratio', event)">重设</button>
                                </div>
                                <div class="tv-dropdown-body">
                                    <div class="tv-field">
                                        <label>最小值</label>
                                        <input type="number" id="filter-volume-ratio-min" value="0.8" step="0.1">
                                    </div>
                                    <div class="tv-field">
                                        <label>最大值</label>
                                        <input type="number" id="filter-volume-ratio-max" value="8" step="0.1">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tv-filter-tab has-dropdown" data-filter="macd">
                            <input type="checkbox" id="filter-macd-enable">
                            <span class="tv-tab-name">MACD</span>
                            <span class="tv-tab-arrow">▼</span>
                            <div class="tv-dropdown">
                                <div class="tv-dropdown-header">
                                    <span>MACD</span>
                                    <button type="button" onclick="resetFilter('macd', event)">重设</button>
                                </div>
                                <div class="tv-dropdown-body">
                                    <div class="tv-field full">
                                        <label>条件</label>
                                        <select id="filter-macd-condition">
                                            <option value="golden">金叉</option>
                                            <option value="dead">死叉</option>
                                            <option value="above_zero">零上</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tv-filter-tab has-dropdown" data-filter="kdj">
                            <input type="checkbox" id="filter-kdj-enable">
                            <span class="tv-tab-name">KDJ</span>
                            <span class="tv-tab-arrow">▼</span>
                            <div class="tv-dropdown">
                                <div class="tv-dropdown-header">
                                    <span>KDJ</span>
                                    <button type="button" onclick="resetFilter('kdj', event)">重设</button>
                                </div>
                                <div class="tv-dropdown-body">
                                    <div class="tv-field full">
                                        <label>条件</label>
                                        <select id="filter-kdj-condition">
                                            <option value="golden">金叉</option>
                                            <option value="dead">死叉</option>
                                            <option value="oversold">超卖</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tv-filter-tab has-dropdown" data-filter="ma">
                            <input type="checkbox" id="filter-ma-enable">
                            <span class="tv-tab-name">MA</span>
                            <span class="tv-tab-arrow">▼</span>
                            <div class="tv-dropdown">
                                <div class="tv-dropdown-header">
                                    <span>移动平均线 (MA)</span>
                                    <button type="button" onclick="resetFilter('ma', event)">重设</button>
                                </div>
                                <div class="tv-dropdown-body">
                                    <div class="tv-field">
                                        <label>周期</label>
                                        <select id="filter-ma-period">
                                            <option value="5">5</option>
                                            <option value="10">10</option>
                                            <option value="20" selected>20</option>
                                            <option value="60">60</option>
                                        </select>
                                    </div>
                                    <div class="tv-field">
                                        <label>条件</label>
                                        <select id="filter-ma-condition">
                                            <option value="above">上穿</option>
                                            <option value="below">下穿</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tv-filter-tab has-dropdown" data-filter="ema">
                            <input type="checkbox" id="filter-ema-enable">
                            <span class="tv-tab-name">EMA</span>
                            <span class="tv-tab-arrow">▼</span>
                            <div class="tv-dropdown">
                                <div class="tv-dropdown-header">
                                    <span>指数移动平均线 (EMA)</span>
                                    <button type="button" onclick="resetFilter('ema', event)">重设</button>
                                </div>
                                <div class="tv-dropdown-body">
                                    <div class="tv-field">
                                        <label>周期</label>
                                        <select id="filter-ema-period">
                                            <option value="12" selected>12</option>
                                            <option value="26">26</option>
                                        </select>
                                    </div>
                                    <div class="tv-field">
                                        <label>条件</label>
                                        <select id="filter-ema-condition">
                                            <option value="above">上穿</option>
                                            <option value="golden">金叉</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tv-filter-tab has-dropdown" data-filter="boll">
                            <input type="checkbox" id="filter-boll-enable">
                            <span class="tv-tab-name">BOLL</span>
                            <span class="tv-tab-arrow">▼</span>
                            <div class="tv-dropdown">
                                <div class="tv-dropdown-header">
                                    <span>布林带 (BOLL)</span>
                                    <button type="button" onclick="resetFilter('boll', event)">重设</button>
                                </div>
                                <div class="tv-dropdown-body">
                                    <div class="tv-field full">
                                        <label>条件</label>
                                        <select id="filter-boll-condition">
                                            <option value="expanding">扩张</option>
                                            <option value="above_mid">上穿中轨</option>
                                            <option value="near_lower">近下轨</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tv-filter-tab has-dropdown" data-filter="bias">
                            <input type="checkbox" id="filter-bias-enable">
                            <span class="tv-tab-name">BIAS</span>
                            <span class="tv-tab-arrow">▼</span>
                            <div class="tv-dropdown">
                                <div class="tv-dropdown-header">
                                    <span>乖离率 (BIAS)</span>
                                    <button type="button" onclick="resetFilter('bias', event)">重设</button>
                                </div>
                                <div class="tv-dropdown-body">
                                    <div class="tv-field">
                                        <label>最小值</label>
                                        <input type="number" id="filter-bias-min" value="-6" step="0.1">
                                    </div>
                                    <div class="tv-field">
                                        <label>最大值</label>
                                        <input type="number" id="filter-bias-max" value="6" step="0.1">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tv-filter-tab has-dropdown" data-filter="adx">
                            <input type="checkbox" id="filter-adx-enable">
                            <span class="tv-tab-name">ADX</span>
                            <span class="tv-tab-arrow">▼</span>
                            <div class="tv-dropdown">
                                <div class="tv-dropdown-header">
                                    <span>平均趋向指数 (ADX)</span>
                                    <button type="button" onclick="resetFilter('adx', event)">重设</button>
                                </div>
                                <div class="tv-dropdown-body">
                                    <div class="tv-field full">
                                        <label>最小值</label>
                                        <input type="number" id="filter-adx-min" value="25" min="0" max="100">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tv-filter-tab" data-filter="williams">
                            <input type="checkbox" id="filter-williams-r-enable">
                            <span class="tv-tab-name">威廉%R</span>
                        </div>
                        <div class="tv-filter-tab" data-filter="break-high">
                            <input type="checkbox" id="filter-break-high-enable">
                            <span class="tv-tab-name">突破高点</span>
                        </div>
                        <div class="tv-filter-tab has-dropdown" data-filter="ichimoku">
                            <input type="checkbox" id="filter-ichimoku-enable">
                            <span class="tv-tab-name">一目均衡</span>
                            <span class="tv-tab-arrow">▼</span>
                            <div class="tv-dropdown">
                                <div class="tv-dropdown-header">
                                    <span>一目均衡表</span>
                                    <button type="button" onclick="resetFilter('ichimoku', event)">重设</button>
                                </div>
                                <div class="tv-dropdown-body">
                                    <div class="tv-field full">
                                        <label>条件</label>
                                        <select id="filter-ichimoku-condition">
                                            <option value="above_cloud">云上</option>
                                            <option value="below_cloud">云下</option>
                                            <option value="tk_cross">转换上穿</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tv-filter-tab tv-filter-count">
                            <span class="tv-tab-name">数量</span>
                            <input type="number" id="selection-max-count" min="5" max="200" value="30">
                        </div>
                    </div>
                    
                    <!-- 操作按钮区域 -->
                    <div class="selection-config-actions">
                        <select id="strategy-preset-select" class="strategy-preset-select" onchange="applyStrategyPreset(this.value)">
                            <option value="">📋 策略预设</option>
                            <option value="short">短期交易</option>
                            <option value="medium">中期波段</option>
                            <option value="long">长期布局</option>
                        </select>
                        <button id="reset-selection-config-btn" class="secondary-btn" onclick="resetSelectionConfig()">🔄 重置</button>
                        <button id="save-selection-config-btn" class="primary-btn" onclick="saveSelectionConfig()">💾 保存配置</button>
                    </div>
                </div>
            </div>
            
            <!-- 选股控制区域 -->
            <div class="strategy-controls">
                <div class="strategy-controls-row">
                    <button id="load-selected-btn" class="secondary-btn">📋 加载上次结果</button>
                    <button id="select-btn" class="primary-btn">🎯 开始选股</button>
                </div>
                <!-- 选股进度显示 -->
                <div id="selection-progress-container" class="selection-progress-container" style="display: none;">
                    <div class="selection-progress-bar-wrapper">
                        <div id="selection-progress-bar" class="selection-progress-fill" style="width: 0%;"></div>
                    </div>
                    <div class="selection-progress-info">
                        <span id="selection-status" class="selection-status">准备中...</span>
                        <span id="selection-progress-text" class="selection-progress-text">0%</span>
                    </div>
                </div>
            </div>

            <!-- 选股结果显示区域 -->
            <div id="selected-stocks" class="selected-stocks-container"></div>
        </section>

        <!-- AI分析面板 -->
        <section id="ai-tab" class="tab-content">
            <div class="ai-analysis-layout">
                <div class="ai-controls">
                    <input type="text" id="ai-code-input" placeholder="输入股票代码（如：600519）">
                    <div class="ai-source-options">
                        <label class="ai-source-label">
                            <input type="checkbox" id="ai-source-watchlist" checked>
                            <span>自选股</span>
                        </label>
                        <label class="ai-source-label">
                            <input type="checkbox" id="ai-source-selection">
                            <span>选股结果</span>
                        </label>
                    </div>
                    <button id="analyze-btn">开始分析</button>
                    <button id="ai-stats-btn" style="margin-left: 12px; padding: 8px 16px; background:#3b82f6; border:none; border-radius:6px; color:white; cursor:pointer;">
                        查看胜率统计
                    </button>
                    <button id="ai-clear-btn" style="margin-left: 12px; padding: 8px 16px; background:#6b7280; border:none; border-radius:6px; color:white; cursor:pointer;">
                        清除AI分析结果
                    </button>
                </div>
                <div id="ai-analysis-result" class="ai-analysis-result">
                    <div class="ai-placeholder">
                        <div style="font-size: 48px; margin-bottom: 16px;">🤖</div>
                        <div style="font-size: 18px; color: #94a3b8; margin-bottom: 8px;">AI股票分析</div>
                        <div style="font-size: 14px; color: #64748b;">输入股票代码，或勾选自选股/选股结果进行批量分析</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 资讯面板 -->
        <section id="news-tab" class="tab-content">
            <div class="news-controls">
                <button id="refresh-news-btn">刷新资讯</button>
            </div>
            <div id="news-list" class="news-list"></div>
        </section>

        <!-- 数据配置面板 -->
        <section id="config-tab" class="tab-content">
            <div class="config-layout">
                <!-- 数据配置（右侧，加长） -->
                <div class="config-main-section config-data-section">
                    <div class="config-main-header" onclick="toggleConfigSection('data')">
                        <h3 style="margin: 0; display: inline-block;">数据配置</h3>
                        <span class="config-main-arrow" id="arrow-data">▶</span>
                    </div>
                    <div class="config-main-content hidden" id="content-data">
                        <div style="margin-bottom: 12px; color: #94a3b8; font-size: 12px;">
                            配置会保存在服务器（Redis）中，影响默认选股参数、行情采集频率和K线数据加载。
                        </div>
                        
                        <!-- 行情采集配置 -->
                        <div class="config-item">
                            <label>
                                行情采集间隔（秒）：
                                <input type="number" id="cfg-collector-interval" min="5" max="3600" value="60">
                                <span style="font-size: 11px; color: #94a3b8; margin-left: 8px;">5-3600</span>
                            </label>
                        </div>
                        
                        <!-- K线数据配置 -->
                        <div class="config-item">
                            <label>
                                K线数据加载年限（年）：
                                <input type="number" id="cfg-kline-years" min="0.5" max="10" step="0.5" value="1">
                                <span style="font-size: 11px; color: #94a3b8; margin-left: 8px;">0.5-10</span>
                            </label>
                        </div>
                        
                        <!-- K线数据源选择 -->
                        <div class="config-item">
                            <label>
                                K线数据源：
                                <select id="cfg-kline-data-source" class="config-select">
                                    <option value="auto">自动切换（推荐）</option>
                                    <option value="akshare">仅 AKShare</option>
                                    <option value="tushare">仅 Tushare</option>
                                    <option value="sina">仅 新浪财经</option>
                                    <option value="easyquotation">仅 Easyquotation</option>
                                </select>
                            </label>
                            <div style="font-size: 11px; color: #64748b; margin-top: 4px;">
                                自动切换：优先使用 AKShare，失败时依次尝试 Tushare、新浪财经、Easyquotation
                            </div>
                        </div>
                        
                        <!-- 实时行情数据源选择 -->
                        <div class="config-item" style="margin-top: 12px;">
                            <label>
                                实时行情数据源：
                                <select id="cfg-spot-data-source" class="config-select">
                                    <option value="auto">自动切换（推荐）</option>
                                    <option value="akshare">仅 AKShare(东方财富)</option>
                                    <option value="sina">仅 新浪财经</option>
                                    <option value="easyquotation">仅 Easyquotation</option>
                                </select>
                            </label>
                            <div style="font-size: 11px; color: #64748b; margin-top: 4px;">
                                自动切换：优先使用 AKShare，失败时依次尝试新浪财经、Easyquotation
                            </div>
                        </div>
                        
                        <!-- Tushare 数据源配置 -->
                        <div class="config-item" style="margin-top: 16px; padding-top: 12px; border-top: 1px solid #334155;">
                            <label style="display: block; margin-bottom: 8px; color: #60a5fa; font-weight: 500;">
                                Tushare 数据源
                            </label>
                        </div>
                        <div class="config-item">
                            <label>
                                Tushare Token：
                                <input type="password" id="cfg-tushare-token" placeholder="输入 Tushare Pro API Token" style="width: 350px;">
                                <span style="font-size: 11px; color: #94a3b8; margin-left: 8px;">🔒 已隐藏</span>
                            </label>
                        </div>
                        <div style="font-size: 11px; color: #64748b; margin-top: 4px;">
                            获取 Token：<a href="https://tushare.pro/register?reg=7" target="_blank" style="color: #60a5fa;">https://tushare.pro</a> 注册后在个人中心获取
                        </div>
                    </div>
                </div>
                
                <!-- 通知配置（左侧，独立折叠项） -->
                <div class="config-main-section config-notify-section">
                    <div class="config-main-header" onclick="toggleConfigSection('notify')">
                        <h3 style="margin: 0; display: inline-block;">通知配置</h3>
                        <span class="config-main-arrow" id="arrow-notify">▶</span>
                    </div>
                    <div class="config-main-content hidden" id="content-notify">
                        <div style="margin-bottom: 12px; color: #94a3b8; font-size: 12px;">
                            配置各通知渠道的发送对象，并可发送测试通知验证是否配置正确。
                        </div>
                        
                        <!-- Telegram配置 -->
                        <div class="config-subsection-small">
                            <div class="config-subsection-small-header" onclick="toggleConfigSubsection('telegram')">
                                <label style="margin: 0; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="cfg-notify-telegram" onclick="event.stopPropagation();"> 
                                    <span>Telegram</span>
                                </label>
                                <span class="config-subsection-arrow" id="arrow-telegram">▶</span>
                            </div>
                            <div class="config-subsection-small-content hidden" id="content-telegram">
                                <div class="config-item">
                                    <label>
                                        Bot Token：
                                        <input type="text" id="cfg-telegram-bot-token" placeholder="例如：123456:ABC-DEF..." style="width: 300px;">
                                    </label>
                                </div>
                                <div class="config-item">
                                    <label>
                                        Chat ID：
                                        <input type="text" id="cfg-telegram-chat-id" placeholder="例如：123456789" style="width: 300px;">
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 邮箱配置 -->
                        <div class="config-subsection-small">
                            <div class="config-subsection-small-header" onclick="toggleConfigSubsection('email')">
                                <label style="margin: 0; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="cfg-notify-email" onclick="event.stopPropagation();"> 
                                    <span>邮箱</span>
                                </label>
                                <span class="config-subsection-arrow" id="arrow-email">▶</span>
                            </div>
                            <div class="config-subsection-small-content hidden" id="content-email">
                                <div class="config-item">
                                    <label>
                                        SMTP 服务器：
                                        <input type="text" id="cfg-email-smtp-host" placeholder="例如：smtp.qq.com" style="width: 300px;">
                                    </label>
                                </div>
                                <div class="config-item">
                                    <label>
                                        SMTP 端口：
                                        <input type="number" id="cfg-email-smtp-port" placeholder="例如：587" style="width: 300px;">
                                    </label>
                                </div>
                                <div class="config-item">
                                    <label>
                                        邮箱账号：
                                        <input type="email" id="cfg-email-user" placeholder="例如：172204206@qq.com" style="width: 300px;">
                                    </label>
                                </div>
                                <div class="config-item">
                                    <label>
                                        邮箱密码：
                                        <input type="password" id="cfg-email-password" placeholder="如果需要更改请输入新密码" style="width: 300px;">
                                        <span style="font-size: 11px; color: #94a3b8; margin-left: 8px;">🔒 已隐藏 - 如果需要更改请输入新密码</span>
                                    </label>
                                </div>
                                <div class="config-item">
                                    <label>
                                        接收邮箱：
                                        <input type="email" id="cfg-email-to" placeholder="例如：user@example.com" style="width: 300px;">
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 企业微信配置 -->
                        <div class="config-subsection-small">
                            <div class="config-subsection-small-header" onclick="toggleConfigSubsection('wechat')">
                                <label style="margin: 0; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="cfg-notify-wechat" onclick="event.stopPropagation();"> 
                                    <span>企业微信</span>
                                </label>
                                <span class="config-subsection-arrow" id="arrow-wechat">▶</span>
                            </div>
                            <div class="config-subsection-small-content hidden" id="content-wechat">
                                <div class="config-item">
                                    <label>
                                        Webhook URL：
                                        <input type="url" id="cfg-wechat-webhook-url" placeholder="例如：https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=..." style="width: 400px;">
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- 测试通知按钮 -->
                        <div class="config-item" style="margin-top: 8px;">
                            <button id="cfg-notify-test-btn" class="config-save-btn" style="padding: 6px 16px; font-size: 14px;">
                                测试通知（发送到已勾选渠道）
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 数据采集和账户安全并排 -->
            <div class="config-layout" style="margin-top: 16px;">
                <!-- 数据采集配置 -->
                <div class="config-main-section">
                    <div class="config-main-header" onclick="toggleConfigSection('collect')">
                        <h3 style="margin: 0; display: inline-block;">数据采集</h3>
                        <span class="config-main-arrow" id="arrow-collect">▶</span>
                    </div>
                    <div class="config-main-content hidden" id="content-collect">
                        <div style="margin-bottom: 12px; color: #94a3b8; font-size: 12px;">
                            批量采集K线数据到数据库，用于选股分析。
                        </div>
                        
                        <!-- 公共选项：市场和周期 -->
                        <div style="display: flex; gap: 16px; margin-bottom: 12px; padding: 8px 12px; background: rgba(30, 41, 59, 0.5); border-radius: 6px;">
                            <label style="display: flex; align-items: center; gap: 6px; font-size: 12px;">
                                市场：
                                <select id="collect-market-select" style="padding: 4px 8px;">
                                    <option value="ALL">全部</option>
                                    <option value="A">A股</option>
                                    <option value="HK">港股</option>
                                </select>
                            </label>
                            <label style="display: flex; align-items: center; gap: 6px; font-size: 12px;">
                                周期：
                                <select id="collect-period-select" style="padding: 4px 8px;">
                                    <option value="daily">日线</option>
                                    <option value="1h">小时</option>
                                </select>
                            </label>
                        </div>
                        
                        <!-- 采集区域横排布局 -->
                        <div style="display: flex; gap: 20px; align-items: flex-start;">
                            <!-- 单个采集（竖排） -->
                            <div style="display: flex; flex-direction: column; gap: 6px;">
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 12px;">
                                    数量：
                                    <input type="number" id="single-batch-size-input" value="1" min="1" max="100" style="width: 50px;">
                                </label>
                                <button id="single-batch-collect-kline-btn" class="action-btn" style="padding: 6px 12px; font-size: 13px;">📥 单个采集</button>
                            </div>
                            
                            <!-- 批量采集（竖排） -->
                            <div style="display: flex; flex-direction: column; gap: 6px;">
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 12px;">
                                    批量：
                                    <input type="number" id="collect-max-count-input" value="6000" min="1" max="10000" style="width: 70px;">
                                </label>
                                <button id="collect-kline-btn" class="success-btn" style="padding: 6px 12px; font-size: 13px;">📥 批量采集</button>
                            </div>
                            
                            <!-- 采集快照按钮 -->
                            <button id="collect-spot-btn" onclick="collectSpotData()" class="action-btn" style="padding: 8px 14px; font-size: 13px;">📊 实时快照</button>
                        </div>
                        
                        <!-- 采集状态和停止按钮 -->
                        <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-top: 10px;">
                            <div style="flex: 1;">
                                <div id="spot-collect-status" style="font-size: 12px; color: #94a3b8; min-height: 16px;"></div>
                                <div id="collect-kline-status" class="status-text" style="min-height: 20px;"></div>
                            </div>
                            <button id="stop-collect-kline-btn" class="danger-btn" style="padding: 6px 12px; font-size: 13px; margin-left: 12px;">🛑 停止采集</button>
                        </div>
                    </div>
                </div>
                
                <!-- 账户安全配置 -->
                <div class="config-main-section">
                    <div class="config-main-header" onclick="toggleConfigSection('security')">
                        <h3 style="margin: 0; display: inline-block;">账户安全</h3>
                        <span class="config-main-arrow" id="arrow-security">▶</span>
                    </div>
                    <div class="config-main-content hidden" id="content-security">
                        <div style="margin-bottom: 12px; color: #94a3b8; font-size: 12px;">
                            修改管理员登录密码。密码将保存在服务器（Redis）中，优先于环境变量。
                        </div>
                        <div class="config-item">
                            <label>
                                当前密码：
                                <input type="password" id="cfg-old-password" placeholder="请输入当前密码" style="width: 200px; margin-left: 8px;">
                            </label>
                        </div>
                        <div class="config-item">
                            <label>
                                新密码：
                                <input type="password" id="cfg-new-password" placeholder="至少6个字符" style="width: 200px; margin-left: 8px;">
                            </label>
                        </div>
                        <div class="config-item">
                            <label>
                                确认密码：
                                <input type="password" id="cfg-confirm-password" placeholder="再次输入新密码" style="width: 200px; margin-left: 8px;">
                            </label>
                        </div>
                        <div class="config-item">
                            <button id="cfg-change-password-btn" class="config-save-btn" style="padding: 6px 16px; font-size: 14px;">
                                修改密码
                            </button>
                            <span id="cfg-password-status" style="margin-left: 12px; font-size: 13px; color: #94a3b8;"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- AI 配置（单独折叠项，位于数据配置下面） -->
            <div class="config-main-section" style="margin-top: 16px;">
                <div class="config-main-header" onclick="toggleConfigSection('ai')">
                    <h3 style="margin: 0; display: inline-block;">AI 配置</h3>
                    <span class="config-main-arrow" id="arrow-ai">▶</span>
                </div>
                <div class="config-main-content hidden" id="content-ai">
                    <div style="margin-bottom: 6px; color: #94a3b8; font-size: 12px;">
                        使用 OpenAI / DeepSeek 等接口进行 AI 分析。
                    </div>
                    <div class="config-item">
                        <label>
                            OpenAI API Key：
                            <input type="password" id="cfg-ai-api-key" placeholder="如果需要更改请输入新值 (sk-...)" style="width: 300px;">
                            <span style="font-size: 11px; color: #94a3b8; margin-left: 8px;">🔒 已隐藏 - 如果需要更改请输入新值 (sk-...)</span>
                        </label>
                    </div>
                    <div class="config-item">
                        <label>
                            API Base URL：
                            <input type="text" id="cfg-ai-api-base" placeholder="https://openai.qiniu.com/v1" style="width: 300px;">
                            <span style="font-size: 11px; color: #94a3b8; margin-left: 8px;">如使用代理或第三方服务，可修改此 URL</span>
                        </label>
                    </div>
                    <div class="config-item">
                        <label>
                            AI 模型：
                            <input type="text" id="cfg-ai-model" placeholder="deepseek/deepseek-v3.2-251201" style="width: 300px;">
                        </label>
                    </div>
                    <div class="config-item">
                        <label>
                            自动分析时间（每天）：
                            <input type="time" id="cfg-ai-auto-analyze-time" style="width: 160px;">
                            <span style="font-size: 11px; color: #94a3b8; margin-left: 8px;">格式 HH:MM，留空则不自动分析</span>
                        </label>
                    </div>
                    <div class="config-item">
                        <label style="margin-right: 16px;">
                            <input type="radio" name="cfg-ai-data-period" id="cfg-ai-data-period-daily" value="daily" checked>
                            <span style="margin-left: 4px;">日线</span>
                        </label>
                        <label style="margin-right: 16px;">
                            <input type="radio" name="cfg-ai-data-period" id="cfg-ai-data-period-hourly" value="1h">
                            <span style="margin-left: 4px;">小时线</span>
                        </label>
                        <label>
                            K线根数：
                            <input type="number" id="cfg-ai-data-count" min="50" max="1000" step="10" value="500" style="width: 100px; margin-left: 8px;">
                            <span style="font-size: 11px; color: #94a3b8; margin-left: 8px;">50-1000，提交给AI的K线数量</span>
                        </label>
                    </div>
                    <div class="config-item">
                        <label>
                            每次分析的股票数：
                            <input type="number" id="cfg-ai-batch-size" min="1" max="1000" step="1" value="5" style="width: 100px; margin-left: 8px;">
                            <span style="font-size: 11px; color: #94a3b8; margin-left: 8px;">1-1000，批量分析时每批合并的股票数</span>
                        </label>
                    </div>
                    <div class="config-item">
                        <label style="margin-right: 16px;">
                            <input type="checkbox" id="cfg-ai-notify-telegram">
                            AI 分析结果通过 Telegram 通知
                        </label>
                        <label style="margin-right: 16px;">
                            <input type="checkbox" id="cfg-ai-notify-email">
                            AI 分析结果通过 邮箱 通知
                        </label>
                        <label>
                            <input type="checkbox" id="cfg-ai-notify-wechat">
                            AI 分析结果通过 企业微信 通知
                        </label>
                    </div>
                </div>
            </div>

            <!-- 数据备份配置 -->
            <div class="config-main-section" style="margin-top: 16px;">
                <div class="config-main-header" onclick="toggleConfigSection('backup')">
                    <h3 style="margin: 0; display: inline-block;">💾 数据备份</h3>
                    <span class="config-main-arrow" id="arrow-backup">▶</span>
                </div>
                <div class="config-main-content hidden" id="content-backup">
                    <div style="margin-bottom: 12px; color: #94a3b8; font-size: 12px;">
                        备份和恢复配置数据，包括：配置页所有设置、选股配置、自选股列表。
                        <br>📁 备份文件将保存到浏览器默认下载目录。
                    </div>
                    
                    <div class="config-item" style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button id="backup-export-btn" class="primary-btn" style="flex: 1; min-width: 120px;">
                            📤 导出备份
                        </button>
                        <button id="backup-import-btn" class="secondary-btn" style="flex: 1; min-width: 120px;">
                            📥 导入备份
                        </button>
                        <input type="file" id="backup-file-input" accept=".json" style="display: none;">
                    </div>
                    
                    <div id="backup-status" style="margin-top: 12px; font-size: 12px; color: #94a3b8;"></div>
                </div>
            </div>

            <!-- 保存配置按钮（右下角） -->
            <div class="config-save-container">
                <div id="cfg-status" style="margin-bottom: 8px; font-size: 13px; color: #94a3b8; text-align: right;"></div>
                <button id="cfg-save-btn" class="config-save-btn">保存配置</button>
            </div>
        </section>
    </div>

    <!-- 全局悬浮提示框 -->
    <div id="global-toast" class="toast" style="display: none;"></div>

    <!-- 先加载 K 线图依赖，再加载应用脚本 -->
    <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <script src="/app.js?v=20251225_18"></script>
</body>
</html>

