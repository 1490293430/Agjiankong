<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, shrink-to-fit=no">
    <meta name="HandheldFriendly" content="true">
    <meta name="MobileOptimized" content="width">
    <meta name="format-detection" content="telephone=no">
    <title>行情监控</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📈</text></svg>">
    <style>
        /* 关键：强制移动端使用正确的视口宽度 */
        html {
            width: 100% !important;
            overflow-x: hidden !important;
            font-size: 16px !important;
            -webkit-text-size-adjust: 100% !important;
            -ms-text-size-adjust: 100% !important;
            text-size-adjust: 100% !important;
        }
        body {
            width: 100% !important;
            min-width: 0 !important;
            max-width: 100vw !important;
            overflow-x: hidden !important;
            font-size: 14px !important;
        }
    </style>
    <link rel="stylesheet" href="style.css?v=20251223_05">
    <script>
        // 在页面渲染前就设置正确的tab，避免闪烁
        // 使用立即执行的函数，尽可能早地执行
        (function() {
            try {
                const savedTab = localStorage.getItem('currentTab') || 'market';
                const validTabs = ['market', 'watchlist', 'strategy', 'ai', 'news', 'config'];
                const targetTab = validTabs.includes(savedTab) ? savedTab : 'market';
                
                // 保存目标tab到全局变量，供DOMContentLoaded时使用
                window.__initialTab = targetTab;
                
                // 立即尝试设置（如果DOM已存在）
                function setInitialTab() {
                    // 移除所有active类
                    const allTabs = document.querySelectorAll('.tab-btn');
                    const allContents = document.querySelectorAll('.tab-content');
                    
                    allTabs.forEach(btn => btn.classList.remove('active'));
                    allContents.forEach(content => content.classList.remove('active'));
                    
                    // 设置正确的active类
                    const targetBtn = document.querySelector(`.tab-btn[data-tab="${targetTab}"]`);
                    const targetContent = document.getElementById(`${targetTab}-tab`);
                    
                    if (targetBtn) targetBtn.classList.add('active');
                    if (targetContent) targetContent.classList.add('active');
                }
                
                // 如果DOM已经存在，立即执行
                if (document.body) {
                    setInitialTab();
                } else {
                    // 否则等待DOMContentLoaded
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', setInitialTab, false);
                    } else {
                        // 如果readyState不是loading，说明可能已经加载完成
                        setTimeout(setInitialTab, 0);
                    }
                }
            } catch (e) {
                console.warn('设置初始tab失败:', e);
            }
        })();
    </script>
    <style>
        /* 在CSS加载前先隐藏所有tab-content，避免闪烁 */
        .tab-content {
            display: none !important;
        }
        .tab-content.active {
            display: block !important;
        }
    </style>
    <script>
        // 在页面渲染前检查登录状态和主题，避免闪烁
        (function() {
            try {
                // 1. 检查并应用主题（在CSS加载前设置，避免主题闪烁）
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme === 'light') {
                    // 立即尝试应用主题（如果DOM已存在）
                    if (document.body) {
                        document.body.classList.add('light-mode');
                    } else {
                        // 如果body还不存在，等待DOMContentLoaded
                        document.addEventListener('DOMContentLoaded', function() {
                            document.body.classList.add('light-mode');
                        }, false);
                    }
                }
                
                // 注意：登录状态检查移到initAuth函数中处理，确保token验证的准确性
            } catch (e) {
                console.warn('初始化失败:', e);
            }
        })();
    </script>
</head>
<body>
    <!-- 登录遮罩层 -->
    <div id="login-overlay" style="position: fixed; inset: 0; background: rgba(15,23,42,0.9); display: flex; align-items: center; justify-content: center; z-index: 1000;">
        <div style="background: #0f172a; padding: 24px 28px; border-radius: 12px; width: 320px; box-shadow: 0 20px 40px rgba(15,23,42,0.8); border: 1px solid #1e293b;">
            <h2 style="margin: 0 0 16px; font-size: 20px; color: #e5e7eb; text-align: center;">管理员登录</h2>
            <form id="login-form">
                <div style="margin-bottom: 10px;">
                    <label style="display:block; font-size: 13px; color:#cbd5f5; margin-bottom:4px;">用户名</label>
                    <input id="login-username" type="text" value="admin" style="width: 100%; padding: 8px 10px; border-radius: 6px; border: 1px solid #1f2937; background:#020617; color:#e5e7eb;">
                </div>
                <div style="margin-bottom: 14px;">
                    <label style="display:block; font-size: 13px; color:#cbd5f5; margin-bottom:4px;">密码</label>
                    <input id="login-password" type="password" value="admin" style="width: 100%; padding: 8px 10px; border-radius: 6px; border: 1px solid #1f2937; background:#020617; color:#e5e7eb;">
                </div>
                <button type="submit" style="width:100%; padding:8px 0; border:none; border-radius:6px; background:#3b82f6; color:white; font-weight:600; cursor:pointer;">
                    登录
                </button>
                <div id="login-message" style="margin-top:8px; font-size:12px; color:#f97316; min-height:16px;"></div>
            </form>
        </div>
    </div>

    <div class="container">
        <!-- 头部导航 -->
        <header class="header">
            <h1>📈 行情监控</h1>
            <div class="nav-tabs">
                <button class="tab-btn" data-tab="market">行情</button>
                <button class="tab-btn" data-tab="watchlist">自选</button>
                <button class="tab-btn" data-tab="strategy">选股</button>
                <button class="tab-btn" data-tab="ai">AI分析</button>
                <button class="tab-btn" data-tab="news">资讯</button>
                <button class="tab-btn" data-tab="config">配置</button>
            </div>
            <div class="header-actions">
                <div class="market-status">
                    <div class="market-status-item">
                        <span class="market-status-label">A股:</span>
                        <span id="market-status-a" class="market-status-value">加载中...</span>
                    </div>
                    <div class="market-status-item">
                        <span class="market-status-label">港股:</span>
                        <span id="market-status-hk" class="market-status-value">加载中...</span>
                    </div>
                    <div class="market-status-item">
                        <span class="market-status-label">SSE:</span>
                        <span id="sse-status-indicator" class="sse-status-indicator disconnected" title="SSE连接状态"></span>
                        <span id="sse-status-text" class="market-status-value" style="margin-left: 4px;">未连接</span>
                    </div>
                </div>
                <button id="theme-toggle" class="theme-toggle-btn" type="button">🌙 夜间</button>
            </div>
        </header>

        <!-- 行情面板 -->
        <section id="market-tab" class="tab-content">
            <div class="market-controls">
                <select id="market-select">
                    <option value="a">A股</option>
                    <option value="hk">港股</option>
                </select>
                <input type="text" id="search-input" placeholder="搜索股票代码或名称...">
                <button id="refresh-btn">刷新</button>
            </div>
            <div class="stock-list-container">
                <table class="stock-table">
                    <thead>
                        <tr>
                            <th>代码</th>
                            <th>名称</th>
                            <th>最新价</th>
                            <th>涨跌幅</th>
                            <th>成交量</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="stock-list">
                        <tr><td colspan="6" class="loading">加载中...</td></tr>
                    </tbody>
                </table>
            </div>
            <div style="color: #94a3b8; font-size: 12px; margin-top: 10px; text-align: center;">💡 单击股票行可查看K线和详情</div>
        </section>

        <!-- 自选股面板 -->
        <section id="watchlist-tab" class="tab-content">
            <div class="watchlist-controls">
                <div style="color: #94a3b8; font-size: 14px;">自选股列表（单击股票查看K线和详情）</div>
            </div>
            <div id="watchlist-container" class="watchlist-container">
                <div class="watchlist-placeholder">
                    <div style="font-size: 48px; margin-bottom: 16px;">⭐</div>
                    <div style="font-size: 18px; color: #94a3b8; margin-bottom: 8px;">暂无自选股</div>
                    <div style="font-size: 14px; color: #64748b;">在行情页点击"加入自选"按钮添加股票</div>
                </div>
            </div>
        </section>
        
        <!-- K线模态弹窗 -->
        <div id="kline-modal" class="kline-modal" style="display: none;">
            <div class="kline-modal-overlay" onclick="closeKlineModal(event)"></div>
            <div class="kline-modal-content">
                <!-- 头部区域：标题、股票详情、操作按钮 -->
                <header class="kline-modal-header">
                    <div class="kline-header-main">
                        <h3 id="kline-modal-title" class="kline-title">K线图</h3>
                        <div id="stock-detail-info" class="stock-detail-info"></div>
                    </div>
                    <div class="kline-header-actions">
                        <button id="kline-refresh-btn" class="kline-action-btn kline-refresh-btn" title="刷新K线数据">
                            <span class="btn-icon">🔄</span>
                            <span class="btn-text">刷新</span>
                        </button>
                        <button class="kline-action-btn kline-modal-close" onclick="closeKlineModal(event)" title="关闭">
                            <span class="btn-icon">×</span>
                        </button>
                    </div>
                </header>
                
                <!-- 主体区域 -->
                <div class="kline-modal-body">
                    <!-- 控制栏：周期选择 + 指标控制 -->
                    <div class="kline-controls-bar">
                        <div class="kline-controls-group">
                            <label class="control-label">周期</label>
                            <select id="chart-period" class="kline-select">
                                <option value="1h">1小时</option>
                                <option value="daily">日线</option>
                                <option value="weekly">周线</option>
                                <option value="monthly">月线</option>
                            </select>
                        </div>
                        <div class="kline-controls-group kline-indicators-group">
                            <div class="indicator-toggle" data-target="volume-controls">
                                <span class="indicator-label">成交量</span>
                                <span class="indicator-arrow">▼</span>
                            </div>
                            <div id="volume-controls" class="indicator-panel">
                                <!-- 成交量控制内容在 JS 中填充 -->
                            </div>
                        </div>
                        <div class="kline-controls-group kline-indicators-group">
                            <div class="indicator-toggle" data-target="ema-controls">
                                <span class="indicator-label">EMA</span>
                                <span class="indicator-arrow">▼</span>
                            </div>
                            <div id="ema-controls" class="indicator-panel">
                                <!-- EMA 控制内容在 JS 中填充 -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- K线图容器 -->
                    <div id="chart-container" class="kline-chart-container"></div>
                    
                    <!-- 指标信息栏 -->
                    <div id="indicators-info" class="indicators-info-bar"></div>
                </div>
            </div>
        </div>

        <!-- 选股面板 -->
        <section id="strategy-tab" class="tab-content">
            <!-- 筛选配置区域 -->
            <div class="selection-config-section">
                <div class="config-header" onclick="toggleSelectionConfig()">
                    <h3 style="margin: 0; display: inline-block; color: #60a5fa;">🎯 筛选配置</h3>
                    <span class="config-arrow collapsed" id="selection-config-arrow">▶</span>
                </div>
                <div class="config-content hidden" id="selection-config-content">
                    <div class="config-grid-compact">
                        <!-- 量比筛选 -->
                        <div class="config-item-compact">
                            <label class="config-checkbox-label">
                                <input type="checkbox" id="filter-volume-ratio-enable" checked>
                                <span class="config-label-text">量比筛选</span>
                            </label>
                            <div class="config-range-inputs">
                                <input type="number" id="filter-volume-ratio-min" step="0.1" min="0.1" max="10" placeholder="0.8" class="range-input">
                                <span class="range-separator">-</span>
                                <input type="number" id="filter-volume-ratio-max" step="0.1" min="1" max="20" placeholder="8.0" class="range-input">
                            </div>
                        </div>
                        
                        <!-- RSI筛选 -->
                        <div class="config-item-compact">
                            <label class="config-checkbox-label">
                                <input type="checkbox" id="filter-rsi-enable" checked>
                                <span class="config-label-text">RSI</span>
                            </label>
                            <div class="config-range-inputs">
                                <input type="number" id="filter-rsi-min" min="0" max="100" placeholder="30" class="range-input">
                                <span class="range-separator">-</span>
                                <input type="number" id="filter-rsi-max" min="0" max="100" placeholder="75" class="range-input">
                            </div>
                        </div>
                        
                        <!-- MA筛选 -->
                        <div class="config-item-compact">
                            <label class="config-checkbox-label">
                                <input type="checkbox" id="filter-ma-enable">
                                <span class="config-label-text">MA均线</span>
                            </label>
                            <div class="config-range-inputs">
                                <select id="filter-ma-period" class="range-input" style="width: 70px;">
                                    <option value="5">MA5</option>
                                    <option value="10">MA10</option>
                                    <option value="20" selected>MA20</option>
                                    <option value="60">MA60</option>
                                </select>
                                <select id="filter-ma-condition" class="range-input" style="width: 70px;">
                                    <option value="above">价上穿</option>
                                    <option value="below">价下穿</option>
                                    <option value="up">向上</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- EMA筛选 -->
                        <div class="config-item-compact">
                            <label class="config-checkbox-label">
                                <input type="checkbox" id="filter-ema-enable">
                                <span class="config-label-text">EMA均线</span>
                            </label>
                            <div class="config-range-inputs">
                                <select id="filter-ema-period" class="range-input" style="width: 70px;">
                                    <option value="12" selected>EMA12</option>
                                    <option value="26">EMA26</option>
                                </select>
                                <select id="filter-ema-condition" class="range-input" style="width: 70px;">
                                    <option value="above">价上穿</option>
                                    <option value="golden">金叉</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- MACD筛选 -->
                        <div class="config-item-compact">
                            <label class="config-checkbox-label">
                                <input type="checkbox" id="filter-macd-enable">
                                <span class="config-label-text">MACD</span>
                            </label>
                            <div class="config-range-inputs">
                                <select id="filter-macd-condition" class="range-input" style="width: 140px;">
                                    <option value="golden">金叉</option>
                                    <option value="dead">死叉</option>
                                    <option value="above_zero">零轴上方</option>
                                    <option value="below_zero">零轴下方</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- KDJ筛选 -->
                        <div class="config-item-compact">
                            <label class="config-checkbox-label">
                                <input type="checkbox" id="filter-kdj-enable">
                                <span class="config-label-text">KDJ</span>
                            </label>
                            <div class="config-range-inputs">
                                <select id="filter-kdj-condition" class="range-input" style="width: 140px;">
                                    <option value="golden">金叉</option>
                                    <option value="dead">死叉</option>
                                    <option value="oversold">超卖区</option>
                                    <option value="overbought">超买区</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- BIAS筛选 -->
                        <div class="config-item-compact">
                            <label class="config-checkbox-label">
                                <input type="checkbox" id="filter-bias-enable">
                                <span class="config-label-text">BIAS乖离率</span>
                            </label>
                            <div class="config-range-inputs">
                                <input type="number" id="filter-bias-min" step="0.1" min="-20" max="20" placeholder="-6" class="range-input">
                                <span class="range-separator">-</span>
                                <input type="number" id="filter-bias-max" step="0.1" min="-20" max="20" placeholder="6" class="range-input">
                            </div>
                        </div>
                        
                        <!-- 威廉指标筛选 -->
                        <div class="config-item-compact">
                            <label class="config-checkbox-label">
                                <input type="checkbox" id="filter-williams-r-enable">
                                <span class="config-label-text">威廉%R</span>
                            </label>
                        </div>
                        
                        <!-- 突破高点筛选 -->
                        <div class="config-item-compact">
                            <label class="config-checkbox-label">
                                <input type="checkbox" id="filter-break-high-enable">
                                <span class="config-label-text">突破高点</span>
                            </label>
                        </div>
                        
                        <!-- 布林带筛选 -->
                        <div class="config-item-compact">
                            <label class="config-checkbox-label">
                                <input type="checkbox" id="filter-boll-enable">
                                <span class="config-label-text">布林带</span>
                            </label>
                            <div class="config-range-inputs">
                                <select id="filter-boll-condition" class="range-input" style="width: 140px;">
                                    <option value="expanding">开口扩张</option>
                                    <option value="above_mid">上穿中轨</option>
                                    <option value="near_lower">接近下轨</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- ADX筛选 -->
                        <div class="config-item-compact">
                            <label class="config-checkbox-label">
                                <input type="checkbox" id="filter-adx-enable">
                                <span class="config-label-text">ADX趋势</span>
                            </label>
                            <div class="config-range-inputs">
                                <input type="number" id="filter-adx-min" min="0" max="100" placeholder="25" class="range-input">
                                <span class="range-separator">></span>
                            </div>
                        </div>
                        
                        <!-- 一目均衡表筛选 -->
                        <div class="config-item-compact">
                            <label class="config-checkbox-label">
                                <input type="checkbox" id="filter-ichimoku-enable">
                                <span class="config-label-text">一目均衡表</span>
                            </label>
                            <div class="config-range-inputs">
                                <select id="filter-ichimoku-condition" class="range-input" style="width: 140px;">
                                    <option value="above_cloud">价格在云上</option>
                                    <option value="below_cloud">价格在云下</option>
                                    <option value="tk_cross">转换线上穿</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- 最大选股数量 -->
                        <div class="config-item-compact">
                            <label class="config-label-text">选股数量</label>
                            <input type="number" id="selection-max-count" min="5" max="200" placeholder="30" class="single-input">
                        </div>
                    </div>
                    <div class="config-actions">
                        <button id="reset-config-btn" class="config-btn secondary">重置默认</button>
                        <button id="save-config-btn" class="config-btn primary">保存配置</button>
                    </div>
                </div>
            </div>

            <!-- 选股控制区域 -->
            <div class="strategy-controls">
                <div class="strategy-controls-row">
                    <label>单个数量：<input type="number" id="single-batch-size-input" value="1" min="1" max="100" class="small-input"></label>
                    <label>
                        市场：
                        <select id="single-batch-market-select" class="small-select">
                            <option value="ALL">A股+港股</option>
                            <option value="A">A股</option>
                            <option value="HK">港股</option>
                        </select>
                    </label>
                    <label>
                        周期：
                        <select id="single-batch-period-select" class="small-select">
                            <option value="daily">日线</option>
                            <option value="1h">小时</option>
                        </select>
                    </label>
                    <button id="single-batch-collect-kline-btn" class="action-btn">📥 单个批量采集</button>
                    <label>采集数量：<input type="number" id="collect-max-count-input" value="6000" min="1" max="10000" class="small-input"></label>
                    <button id="collect-kline-btn" class="success-btn">📥 批量采集</button>
                    <button id="stop-collect-kline-btn" class="danger-btn">🛑 停止采集</button>
                    <div class="strategy-controls-spacer"></div>
                    <button id="load-selected-btn" class="secondary-btn">📋 加载上次结果</button>
                    <button id="select-btn" class="primary-btn">🎯 开始选股</button>
                </div>
                <div id="collect-kline-status" class="status-text"></div>
                <!-- 选股进度显示 -->
                <div id="selection-progress-container" class="selection-progress-container" style="display: none;">
                    <div class="selection-progress-bar-wrapper">
                        <div id="selection-progress-bar" class="selection-progress-fill" style="width: 0%;"></div>
                    </div>
                    <div class="selection-progress-info">
                        <span id="selection-status" class="selection-status">准备中...</span>
                        <span id="selection-progress-text" class="selection-progress-text">0%</span>
                    </div>
                </div>
            </div>

            <!-- 选股结果显示区域 -->
            <div id="selected-stocks" class="selected-stocks-container"></div>
        </section>

        <!-- AI分析面板 -->
        <section id="ai-tab" class="tab-content">
            <div class="ai-analysis-layout">
                <div class="ai-controls">
                    <input type="text" id="ai-code-input" placeholder="输入股票代码（如：600519）">
                    <div class="ai-source-options">
                        <label class="ai-source-label">
                            <input type="checkbox" id="ai-source-watchlist" checked>
                            <span>自选股</span>
                        </label>
                        <label class="ai-source-label">
                            <input type="checkbox" id="ai-source-selection">
                            <span>选股结果</span>
                        </label>
                    </div>
                    <button id="analyze-btn">开始分析</button>
                    <button id="ai-stats-btn" style="margin-left: 12px; padding: 8px 16px; background:#3b82f6; border:none; border-radius:6px; color:white; cursor:pointer;">
                        查看胜率统计
                    </button>
                    <button id="ai-clear-btn" style="margin-left: 12px; padding: 8px 16px; background:#6b7280; border:none; border-radius:6px; color:white; cursor:pointer;">
                        清除AI分析结果
                    </button>
                </div>
                <div id="ai-analysis-result" class="ai-analysis-result">
                    <div class="ai-placeholder">
                        <div style="font-size: 48px; margin-bottom: 16px;">🤖</div>
                        <div style="font-size: 18px; color: #94a3b8; margin-bottom: 8px;">AI股票分析</div>
                        <div style="font-size: 14px; color: #64748b;">输入股票代码，或勾选自选股/选股结果进行批量分析</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 资讯面板 -->
        <section id="news-tab" class="tab-content">
            <div class="news-controls">
                <button id="refresh-news-btn">刷新资讯</button>
            </div>
            <div id="news-list" class="news-list"></div>
        </section>

        <!-- 数据配置面板 -->
        <section id="config-tab" class="tab-content">
            <div class="config-layout">
                <!-- 数据配置（右侧，加长） -->
                <div class="config-main-section config-data-section">
                    <div class="config-main-header" onclick="toggleConfigSection('data')">
                        <h3 style="margin: 0; display: inline-block;">数据配置</h3>
                        <span class="config-main-arrow" id="arrow-data">▶</span>
                    </div>
                    <div class="config-main-content hidden" id="content-data">
                        <div style="margin-bottom: 12px; color: #94a3b8; font-size: 12px;">
                            配置会保存在服务器（Redis）中，影响默认选股参数、行情采集频率和K线数据加载。
                        </div>
                        
                        <!-- 行情采集配置 -->
                        <div class="config-item">
                            <label>
                                行情采集间隔（秒）：
                                <input type="number" id="cfg-collector-interval" min="5" max="3600" value="60">
                            </label>
                        </div>
                        
                        <!-- K线数据配置 -->
                        <div class="config-item">
                            <label>
                                K线数据加载年限（年）：
                                <input type="number" id="cfg-kline-years" min="0.5" max="10" step="0.5" value="1">
                            </label>
                        </div>
                        
                        <!-- Tushare 数据源配置 -->
                        <div class="config-item" style="margin-top: 16px; padding-top: 12px; border-top: 1px solid #334155;">
                            <label style="display: block; margin-bottom: 8px; color: #60a5fa; font-weight: 500;">
                                Tushare 数据源
                            </label>
                        </div>
                        <div class="config-item">
                            <label>
                                Tushare Token：
                                <input type="password" id="cfg-tushare-token" placeholder="输入 Tushare Pro API Token" style="width: 350px;">
                                <span style="font-size: 11px; color: #94a3b8; margin-left: 8px;">🔒 已隐藏</span>
                            </label>
                        </div>
                        <div style="font-size: 11px; color: #64748b; margin-top: 4px;">
                            获取 Token：<a href="https://tushare.pro/register?reg=7" target="_blank" style="color: #60a5fa;">https://tushare.pro</a> 注册后在个人中心获取
                        </div>
                    </div>
                </div>
                
                <!-- 通知配置（左侧，独立折叠项） -->
                <div class="config-main-section config-notify-section">
                    <div class="config-main-header" onclick="toggleConfigSection('notify')">
                        <h3 style="margin: 0; display: inline-block;">通知配置</h3>
                        <span class="config-main-arrow" id="arrow-notify">▶</span>
                    </div>
                    <div class="config-main-content hidden" id="content-notify">
                        <div style="margin-bottom: 12px; color: #94a3b8; font-size: 12px;">
                            配置各通知渠道的发送对象，并可发送测试通知验证是否配置正确。
                        </div>
                        
                        <!-- Telegram配置 -->
                        <div class="config-subsection-small">
                            <div class="config-subsection-small-header" onclick="toggleConfigSubsection('telegram')">
                                <label style="margin: 0; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="cfg-notify-telegram" onclick="event.stopPropagation();"> 
                                    <span>Telegram</span>
                                </label>
                                <span class="config-subsection-arrow" id="arrow-telegram">▶</span>
                            </div>
                            <div class="config-subsection-small-content hidden" id="content-telegram">
                                <div class="config-item">
                                    <label>
                                        Bot Token：
                                        <input type="text" id="cfg-telegram-bot-token" placeholder="例如：123456:ABC-DEF..." style="width: 300px;">
                                    </label>
                                </div>
                                <div class="config-item">
                                    <label>
                                        Chat ID：
                                        <input type="text" id="cfg-telegram-chat-id" placeholder="例如：123456789" style="width: 300px;">
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 邮箱配置 -->
                        <div class="config-subsection-small">
                            <div class="config-subsection-small-header" onclick="toggleConfigSubsection('email')">
                                <label style="margin: 0; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="cfg-notify-email" onclick="event.stopPropagation();"> 
                                    <span>邮箱</span>
                                </label>
                                <span class="config-subsection-arrow" id="arrow-email">▶</span>
                            </div>
                            <div class="config-subsection-small-content hidden" id="content-email">
                                <div class="config-item">
                                    <label>
                                        SMTP 服务器：
                                        <input type="text" id="cfg-email-smtp-host" placeholder="例如：smtp.qq.com" style="width: 300px;">
                                    </label>
                                </div>
                                <div class="config-item">
                                    <label>
                                        SMTP 端口：
                                        <input type="number" id="cfg-email-smtp-port" placeholder="例如：587" style="width: 300px;">
                                    </label>
                                </div>
                                <div class="config-item">
                                    <label>
                                        邮箱账号：
                                        <input type="email" id="cfg-email-user" placeholder="例如：172204206@qq.com" style="width: 300px;">
                                    </label>
                                </div>
                                <div class="config-item">
                                    <label>
                                        邮箱密码：
                                        <input type="password" id="cfg-email-password" placeholder="如果需要更改请输入新密码" style="width: 300px;">
                                        <span style="font-size: 11px; color: #94a3b8; margin-left: 8px;">🔒 已隐藏 - 如果需要更改请输入新密码</span>
                                    </label>
                                </div>
                                <div class="config-item">
                                    <label>
                                        接收邮箱：
                                        <input type="email" id="cfg-email-to" placeholder="例如：user@example.com" style="width: 300px;">
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 企业微信配置 -->
                        <div class="config-subsection-small">
                            <div class="config-subsection-small-header" onclick="toggleConfigSubsection('wechat')">
                                <label style="margin: 0; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="cfg-notify-wechat" onclick="event.stopPropagation();"> 
                                    <span>企业微信</span>
                                </label>
                                <span class="config-subsection-arrow" id="arrow-wechat">▶</span>
                            </div>
                            <div class="config-subsection-small-content hidden" id="content-wechat">
                                <div class="config-item">
                                    <label>
                                        Webhook URL：
                                        <input type="url" id="cfg-wechat-webhook-url" placeholder="例如：https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=..." style="width: 400px;">
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- 测试通知按钮 -->
                        <div class="config-item" style="margin-top: 8px;">
                            <button id="cfg-notify-test-btn" class="config-save-btn" style="padding: 6px 16px; font-size: 14px;">
                                测试通知（发送到已勾选渠道）
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 账户安全配置（单独折叠项，位于数据配置下面） -->
            <div class="config-main-section" style="margin-top: 16px;">
                <div class="config-main-header" onclick="toggleConfigSection('security')">
                    <h3 style="margin: 0; display: inline-block;">账户安全</h3>
                    <span class="config-main-arrow" id="arrow-security">▶</span>
                </div>
                <div class="config-main-content hidden" id="content-security">
                    <div style="margin-bottom: 12px; color: #94a3b8; font-size: 12px;">
                        修改管理员登录密码。密码将保存在服务器（Redis）中，优先于环境变量。
                    </div>
                    <div class="config-item">
                        <label>
                            当前密码：
                            <input type="password" id="cfg-old-password" placeholder="请输入当前密码" style="width: 300px; margin-left: 8px;">
                        </label>
                    </div>
                    <div class="config-item">
                        <label>
                            新密码：
                            <input type="password" id="cfg-new-password" placeholder="请输入新密码（至少6个字符）" style="width: 300px; margin-left: 8px;">
                            <span style="font-size: 11px; color: #94a3b8; margin-left: 8px;">至少6个字符</span>
                        </label>
                    </div>
                    <div class="config-item">
                        <label>
                            确认新密码：
                            <input type="password" id="cfg-confirm-password" placeholder="请再次输入新密码" style="width: 300px; margin-left: 8px;">
                        </label>
                    </div>
                    <div class="config-item">
                        <button id="cfg-change-password-btn" class="config-save-btn" style="padding: 6px 16px; font-size: 14px;">
                            修改密码
                        </button>
                        <span id="cfg-password-status" style="margin-left: 12px; font-size: 13px; color: #94a3b8;"></span>
                    </div>
                </div>
            </div>
            
            <!-- AI 配置（单独折叠项，位于数据配置下面） -->
            <div class="config-main-section" style="margin-top: 16px;">
                <div class="config-main-header" onclick="toggleConfigSection('ai')">
                    <h3 style="margin: 0; display: inline-block;">AI 配置</h3>
                    <span class="config-main-arrow" id="arrow-ai">▶</span>
                </div>
                <div class="config-main-content hidden" id="content-ai">
                    <div style="margin-bottom: 6px; color: #94a3b8; font-size: 12px;">
                        使用 OpenAI / DeepSeek 等接口进行 AI 分析。
                    </div>
                    <div class="config-item">
                        <label>
                            OpenAI API Key：
                            <input type="password" id="cfg-ai-api-key" placeholder="如果需要更改请输入新值 (sk-...)" style="width: 300px;">
                            <span style="font-size: 11px; color: #94a3b8; margin-left: 8px;">🔒 已隐藏 - 如果需要更改请输入新值 (sk-...)</span>
                        </label>
                    </div>
                    <div class="config-item">
                        <label>
                            API Base URL：
                            <input type="text" id="cfg-ai-api-base" placeholder="https://openai.qiniu.com/v1" style="width: 300px;">
                            <span style="font-size: 11px; color: #94a3b8; margin-left: 8px;">如使用代理或第三方服务，可修改此 URL</span>
                        </label>
                    </div>
                    <div class="config-item">
                        <label>
                            AI 模型：
                            <input type="text" id="cfg-ai-model" placeholder="deepseek/deepseek-v3.2-251201" style="width: 300px;">
                        </label>
                    </div>
                    <div class="config-item">
                        <label>
                            自动分析时间（每天）：
                            <input type="time" id="cfg-ai-auto-analyze-time" style="width: 160px;">
                            <span style="font-size: 11px; color: #94a3b8; margin-left: 8px;">格式 HH:MM，留空则不自动分析</span>
                        </label>
                    </div>
                    <div class="config-item">
                        <label style="margin-right: 16px;">
                            <input type="radio" name="cfg-ai-data-period" id="cfg-ai-data-period-daily" value="daily" checked>
                            <span style="margin-left: 4px;">日线</span>
                        </label>
                        <label style="margin-right: 16px;">
                            <input type="radio" name="cfg-ai-data-period" id="cfg-ai-data-period-hourly" value="1h">
                            <span style="margin-left: 4px;">小时线</span>
                        </label>
                        <label>
                            K线根数：
                            <input type="number" id="cfg-ai-data-count" min="50" max="1000" step="10" value="500" style="width: 100px; margin-left: 8px;">
                            <span style="font-size: 11px; color: #94a3b8; margin-left: 8px;">提交给AI的K线数量</span>
                        </label>
                    </div>
                    <div class="config-item">
                        <label>
                            每次分析的股票数：
                            <input type="number" id="cfg-ai-batch-size" min="1" max="1000" step="1" value="5" style="width: 100px; margin-left: 8px;">
                            <span style="font-size: 11px; color: #94a3b8; margin-left: 8px;">批量分析时，每批合并分析的股票数量（1-1000）</span>
                        </label>
                    </div>
                    <div class="config-item">
                        <label style="margin-right: 16px;">
                            <input type="checkbox" id="cfg-ai-notify-telegram">
                            AI 分析结果通过 Telegram 通知
                        </label>
                        <label style="margin-right: 16px;">
                            <input type="checkbox" id="cfg-ai-notify-email">
                            AI 分析结果通过 邮箱 通知
                        </label>
                        <label>
                            <input type="checkbox" id="cfg-ai-notify-wechat">
                            AI 分析结果通过 企业微信 通知
                        </label>
                    </div>
                </div>
            </div>

            <!-- 保存配置按钮（右下角） -->
            <div class="config-save-container">
                <div id="cfg-status" style="margin-bottom: 8px; font-size: 13px; color: #94a3b8; text-align: right;"></div>
                <button id="cfg-save-btn" class="config-save-btn">保存配置</button>
            </div>
        </section>
    </div>

    <!-- 全局悬浮提示框 -->
    <div id="global-toast" class="toast" style="display: none;"></div>

    <!-- 先加载 K 线图依赖，再加载应用脚本 -->
    <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <script src="app.js?v=20251223_03"></script>
</body>
</html>

