<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Kçº¿è¯Šæ–­å·¥å…·</title>
    <style>
        body { 
            font-family: 'Consolas', 'Monaco', monospace; 
            padding: 20px; 
            background: #0f172a; 
            color: #e2e8f0; 
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 { color: #60a5fa; margin-bottom: 20px; }
        h2 { color: #94a3b8; margin-top: 30px; margin-bottom: 15px; font-size: 18px; }
        .test { 
            margin: 10px 0; 
            padding: 12px; 
            border-radius: 6px; 
            font-size: 14px;
        }
        .pass { background: rgba(16, 185, 129, 0.15); border-left: 4px solid #10b981; }
        .fail { background: rgba(239, 68, 68, 0.15); border-left: 4px solid #ef4444; }
        .warn { background: rgba(245, 158, 11, 0.15); border-left: 4px solid #f59e0b; }
        pre { 
            background: #1e293b; 
            padding: 12px; 
            border-radius: 4px; 
            overflow-x: auto; 
            font-size: 12px;
            line-height: 1.5;
            margin-top: 8px;
        }
        .input-group {
            margin: 20px 0;
            padding: 15px;
            background: #1e293b;
            border-radius: 6px;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #94a3b8;
        }
        .input-group input {
            width: 200px;
            padding: 8px 12px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 4px;
            color: #e2e8f0;
            font-family: monospace;
        }
        .input-group button {
            padding: 8px 20px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
            font-weight: 600;
        }
        .input-group button:hover {
            background: #2563eb;
        }
        #chart-container {
            width: 100%;
            height: 400px;
            margin-top: 20px;
            background: #1e293b;
            border-radius: 6px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
        }
    </style>
</head>
<body>
    <h1>ğŸ“Š Kçº¿å›¾è¯Šæ–­å·¥å…·</h1>
    
    <div class="input-group">
        <label>è¾“å…¥è‚¡ç¥¨ä»£ç æµ‹è¯•ï¼ˆä¾‹å¦‚ï¼š600089ï¼‰</label>
        <input type="text" id="stock-code" value="600089" placeholder="è‚¡ç¥¨ä»£ç ">
        <button onclick="testStockData()">æµ‹è¯•æ•°æ®</button>
    </div>
    
    <h2>ğŸ” åŸºç¡€æ£€æŸ¥</h2>
    <div id="basic-results"></div>
    
    <h2>ğŸ“ˆ æ•°æ®æ£€æŸ¥</h2>
    <div id="data-results"></div>
    
    <h2>ğŸ¨ æ¸²æŸ“æµ‹è¯•</h2>
    <div id="chart-container"></div>
    
    <script src="/lightweight-charts.js"></script>
    <script>
        const basicResults = document.getElementById('basic-results');
        const dataResults = document.getElementById('data-results');
        const chartContainer = document.getElementById('chart-container');
        
        function addTest(container, name, passed, details = '', type = 'test') {
            const div = document.createElement('div');
            div.className = `${type} ${passed === null ? 'warn' : (passed ? 'pass' : 'fail')}`;
            const icon = passed === null ? 'âš ï¸' : (passed ? 'âœ…' : 'âŒ');
            div.innerHTML = `
                <strong>${icon} ${name}</strong>
                ${details ? `<pre>${details}</pre>` : ''}
            `;
            container.appendChild(div);
        }
        
        // ========== åŸºç¡€æ£€æŸ¥ ==========
        
        // æµ‹è¯•1: LightweightChartsåº“
        setTimeout(() => {
            const hasLib = typeof window.LightweightCharts !== 'undefined';
            addTest(basicResults, 'LightweightChartsåº“åŠ è½½', hasLib, 
                hasLib ? 'window.LightweightCharts å·²åŠ è½½' : 'âŒ åº“æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ä½¿ç”¨æœ¬åœ°æ–‡ä»¶');
            
            if (hasLib) {
                const hasCreateChart = typeof window.LightweightCharts.createChart === 'function';
                addTest(basicResults, 'createChartæ–¹æ³•', hasCreateChart);
                
                // æµ‹è¯•åˆ›å»ºå›¾è¡¨
                if (hasCreateChart) {
                    try {
                        const testDiv = document.createElement('div');
                        testDiv.style.width = '100px';
                        testDiv.style.height = '100px';
                        testDiv.style.display = 'none';
                        document.body.appendChild(testDiv);
                        
                        const chart = window.LightweightCharts.createChart(testDiv, {
                            width: 100,
                            height: 100
                        });
                        
                        const series = chart.addCandlestickSeries();
                        series.setData([
                            { time: '2024-01-01', open: 100, high: 110, low: 95, close: 105 }
                        ]);
                        
                        addTest(basicResults, 'å›¾è¡¨åˆ›å»ºå’Œæ•°æ®è®¾ç½®', true, 'æµ‹è¯•å›¾è¡¨åˆ›å»ºæˆåŠŸ');
                        
                        chart.remove();
                        testDiv.remove();
                    } catch (e) {
                        addTest(basicResults, 'å›¾è¡¨åˆ›å»ºå’Œæ•°æ®è®¾ç½®', false, `é”™è¯¯: ${e.message}\n${e.stack}`);
                    }
                }
            }
        }, 500);
        
        // æµ‹è¯•APIè¿æ¥
        fetch('/api/config')
            .then(res => res.json())
            .then(data => {
                addTest(basicResults, 'APIæœåŠ¡è¿æ¥', true, 
                    `é…ç½®åŠ è½½æˆåŠŸ\nKçº¿å¹´é™: ${data.kline_years || 1}å¹´`);
            })
            .catch(e => {
                addTest(basicResults, 'APIæœåŠ¡è¿æ¥', false, `è¿æ¥å¤±è´¥: ${e.message}`);
            });
        
        // ========== æ•°æ®æ£€æŸ¥å‡½æ•° ==========
        
        window.testStockData = async function() {
            const code = document.getElementById('stock-code').value.trim();
            if (!code) {
                alert('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ');
                return;
            }
            
            dataResults.innerHTML = '<div class="loading">æ­£åœ¨æ£€æŸ¥æ•°æ®...</div>';
            chartContainer.innerHTML = '<div class="loading">å‡†å¤‡æ¸²æŸ“...</div>';
            
            try {
                // 1. æ£€æŸ¥æ•°æ®æ˜¯å¦å­˜åœ¨
                const endDate = new Date();
                const startDate = new Date();
                startDate.setFullYear(startDate.getFullYear() - 1);
                
                const startDateStr = startDate.toISOString().split('T')[0].replace(/-/g, '');
                const endDateStr = endDate.toISOString().split('T')[0].replace(/-/g, '');
                
                const url = `/api/market/a/kline?code=${code}&period=daily&start_date=${startDateStr}&end_date=${endDateStr}`;
                
                dataResults.innerHTML = '';
                addTest(dataResults, 'è¯·æ±‚URL', true, url);
                
                const response = await fetch(url);
                addTest(dataResults, 'HTTPå“åº”', response.ok, 
                    `çŠ¶æ€ç : ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    addTest(dataResults, 'é”™è¯¯è¯¦æƒ…', false, errorText);
                    return;
                }
                
                const result = await response.json();
                addTest(dataResults, 'JSONè§£æ', true, 
                    `code: ${result.code}\nmessage: ${result.message || 'success'}`);
                
                if (result.code !== 0) {
                    addTest(dataResults, 'ä¸šåŠ¡é€»è¾‘', false, 
                        `é”™è¯¯ç : ${result.code}\næ¶ˆæ¯: ${result.message}`);
                    return;
                }
                
                const data = result.data || [];
                addTest(dataResults, 'æ•°æ®æ¡æ•°', data.length > 0, 
                    `å…± ${data.length} æ¡æ•°æ®`);
                
                if (data.length === 0) {
                    addTest(dataResults, 'æ•°æ®ä¸ºç©º', false, 
                        'å¯èƒ½åŸå› ï¼š\n1. è‚¡ç¥¨ä»£ç ä¸å­˜åœ¨\n2. æ•°æ®å°šæœªé‡‡é›†\n3. æ—¥æœŸèŒƒå›´å†…æ— æ•°æ®');
                    return;
                }
                
                // 2. æ£€æŸ¥æ•°æ®æ ¼å¼
                const firstItem = data[0];
                const lastItem = data[data.length - 1];
                
                const requiredFields = ['date', 'open', 'high', 'low', 'close', 'volume'];
                const missingFields = requiredFields.filter(f => !(f in firstItem));
                
                addTest(dataResults, 'æ•°æ®å­—æ®µå®Œæ•´æ€§', missingFields.length === 0,
                    missingFields.length === 0 
                        ? `æ‰€æœ‰å¿…éœ€å­—æ®µéƒ½å­˜åœ¨: ${requiredFields.join(', ')}`
                        : `ç¼ºå°‘å­—æ®µ: ${missingFields.join(', ')}`);
                
                // 3. æ£€æŸ¥æ•°æ®æœ‰æ•ˆæ€§
                const invalidData = data.filter(item => {
                    return !item.date || 
                           item.open === null || item.open === undefined ||
                           item.high === null || item.high === undefined ||
                           item.low === null || item.low === undefined ||
                           item.close === null || item.close === undefined;
                });
                
                addTest(dataResults, 'æ•°æ®æœ‰æ•ˆæ€§', invalidData.length === 0,
                    invalidData.length === 0
                        ? 'æ‰€æœ‰æ•°æ®éƒ½æœ‰æ•ˆ'
                        : `å‘ç° ${invalidData.length} æ¡æ— æ•ˆæ•°æ®\nç¤ºä¾‹: ${JSON.stringify(invalidData[0], null, 2)}`);
                
                // 4. æ˜¾ç¤ºæ•°æ®æ ·æœ¬
                addTest(dataResults, 'æ•°æ®æ ·æœ¬', null,
                    `ç¬¬ä¸€æ¡: ${JSON.stringify(firstItem, null, 2)}\n\næœ€åä¸€æ¡: ${JSON.stringify(lastItem, null, 2)}`, 'warn');
                
                // 5. å°è¯•æ¸²æŸ“
                if (window.LightweightCharts && data.length > 0) {
                    try {
                        chartContainer.innerHTML = '';
                        
                        const chart = window.LightweightCharts.createChart(chartContainer, {
                            width: chartContainer.clientWidth,
                            height: 400,
                            layout: {
                                background: { color: '#1e293b' },
                                textColor: '#94a3b8'
                            },
                            grid: {
                                vertLines: { color: '#334155' },
                                horzLines: { color: '#334155' }
                            }
                        });
                        
                        const candleSeries = chart.addCandlestickSeries({
                            upColor: '#ef4444',
                            downColor: '#22c55e',
                            borderUpColor: '#ef4444',
                            borderDownColor: '#22c55e',
                            wickUpColor: '#ef4444',
                            wickDownColor: '#22c55e'
                        });
                        
                        // è½¬æ¢æ•°æ®æ ¼å¼
                        const chartData = data.map(item => ({
                            time: item.date.replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3'),
                            open: parseFloat(item.open),
                            high: parseFloat(item.high),
                            low: parseFloat(item.low),
                            close: parseFloat(item.close)
                        }));
                        
                        candleSeries.setData(chartData);
                        chart.timeScale().fitContent();
                        
                        addTest(dataResults, 'Kçº¿å›¾æ¸²æŸ“', true, 
                            `æˆåŠŸæ¸²æŸ“ ${chartData.length} æ¡Kçº¿æ•°æ®`);
                        
                    } catch (e) {
                        addTest(dataResults, 'Kçº¿å›¾æ¸²æŸ“', false, 
                            `æ¸²æŸ“å¤±è´¥: ${e.message}\n${e.stack}`);
                        chartContainer.innerHTML = `<div class="loading" style="color: #ef4444;">æ¸²æŸ“å¤±è´¥: ${e.message}</div>`;
                    }
                } else {
                    addTest(dataResults, 'Kçº¿å›¾æ¸²æŸ“', false, 
                        'LightweightChartsåº“æœªåŠ è½½æˆ–æ•°æ®ä¸ºç©º');
                }
                
            } catch (e) {
                dataResults.innerHTML = '';
                addTest(dataResults, 'æµ‹è¯•è¿‡ç¨‹', false, 
                    `å‘ç”Ÿé”™è¯¯: ${e.message}\n${e.stack}`);
            }
        };
        
        // è‡ªåŠ¨æµ‹è¯•é»˜è®¤è‚¡ç¥¨
        setTimeout(() => {
            testStockData();
        }, 1000);
    </script>
</body>
</html>
